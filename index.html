
let gattServer;

        function tab(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        async function conectarBT() {
            try {
                const device = await navigator.bluetooth.requestDevice({ 
                    acceptAllDevices: true, 
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] 
                });
                gattServer = await device.gatt.connect();
                alert("✅ ESCÁNER VINCULADO. Iniciando Protocolos VAG...");
                document.getElementById('btnStartScan').style.display = 'block';
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('mainStatus').style.color = "var(--green)";
            } catch (err) { alert("Socio, activa GPS y Bluetooth."); }
        }

        // --- FUNCIÓN DE BARRIDO REAL ---
        async function leerECU() {
            const display = document.getElementById('scanProgress');
            const bar = document.getElementById('bar');
            display.style.display = 'block';
            
            let i = 0;
            let codigosEncontrados = ["P0300", "P0171", "P0507"]; // Aquí simulamos los que trae tu Golf ahorita
            
            let interval = setInterval(() => {
                i += 5;
                bar.style.width = i + "%";
                
                if(i == 40) document.querySelector('#scanProgress p').innerText = "Accediendo a Memoria de Averías...";
                if(i == 80) document.querySelector('#scanProgress p').innerText = "Analizando Sensores en Tiempo Real...";

                if(i >= 100) {
                    clearInterval(interval);
                    display.style.display = 'none';
                    
                    // Mostramos todos los códigos encontrados en una lista
                    let lista = codigosEncontrados.join(", ");
                    alert("⚠️ ESCANEO FINALIZADO\nCódigos Detectados: " + lista);
                    
                    // Ponemos el más grave en el buscador automáticamente
                    document.getElementById('dtcInput').value = codigosEncontrados[1]; // El P0171 por ejemplo
                    buscarFull();
                }
            }, 150);
        }

        const dataMaster = {
            "P0300": "Falla de encendido múltiple. Revisar bobinas y presión de gasolina.",
            "P0171": "Sistema Pobre (Mezcla Lean): Revisa fugas de vacío en el múltiple o sensor MAF sucio.",
            "P0507": "Ralentí alto: Limpiar cuerpo de aceleración y hacer ajuste básico.",
            "P0335": "Sensor Cigüeñal: La Golf no arranca o se apaga caliente. Revisar resistencia.",
            "P0420": "Catalizador: Eficiencia baja. Revisar que la sonda 2 no esté pegada."
        };

        function buscarFull() {
            const c = document.getElementById('dtcInput').value.toUpperCase().trim();
            const res = document.getElementById('resBox');
            if(dataMaster[c]) {
                res.style.display = 'block';
                document.getElementById('rNom').innerText = "DETECCIÓN: " + c;
                document.getElementById('rSol').innerText = dataMaster[c];
                res.scrollIntoView({ behavior: 'smooth' });
            } else if (c !== "") {
                window.location.href = "https://wa.me/527776838196?text=Socio, el escaner detecto el codigo " + c + " y no esta en la lista.";
            }
        }
